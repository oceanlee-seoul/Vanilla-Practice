<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emoji Matching Game</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="container">
      <h1>카드 맞추기</h1>
      <span class="timer" id="timer">00:00</span>
      <div id="cardWrapper" class="cardWrapper"></div>
      <button id="startButton">시작하기</button>
    </div>

    <script>
      const wrapper = document.querySelector('#cardWrapper');
      const startButton = document.querySelector('#startButton');
      const timerDisplay = document.querySelector('#timer');

      const total = 16;
      const emojis = ['😄', '🐶', '🌸', '⭐', '🍎', '🎵', '🚗', '🎲'];
      let emojiCopy = emojis.concat(emojis);

      let shuffled = [];
      let clicked = [];
      let completed = [];
      let clickable;
      let timer;
      let elapsedSeconds = 0;

      function shuffle() {
        for (let i = 0; emojiCopy.length > 0; i += 1) {
          const randomIndex = Math.floor(Math.random() * emojiCopy.length);
          shuffled = shuffled.concat(emojiCopy.splice(randomIndex, 1));
        }
      }

      function createCard(i) {
        const card = document.createElement('div');
        card.className = 'card';
        const cardInner = document.createElement('div');
        cardInner.className = 'card-inner';
        const cardFront = document.createElement('div');
        cardFront.className = 'card-front';
        const cardBack = document.createElement('div');
        cardBack.className = 'card-back';
        const emoji = document.createElement('p');
        emoji.className = 'emoji';
        emoji.textContent = shuffled[i];
        cardBack.appendChild(emoji);
        cardInner.appendChild(cardFront);
        cardInner.appendChild(cardBack);
        card.appendChild(cardInner);
        return card;
      }

      function onClickCard(event) {
        if (!clickable) return;
        const card = event.target.closest('.card');
        if (card.classList.contains('flipped')) return;
        card.classList.toggle('flipped');
        clicked.push(card);
        if (clicked.length !== 2) {
          return;
        }
        clickable = false;

        const firstEmoji = clicked[0].querySelector('.card-back p').textContent;
        const secondEmoji =
          clicked[1].querySelector('.card-back p').textContent;

        if (firstEmoji === secondEmoji) {
          completed.push(...clicked.splice(0, 2));
          clickable = true;

          if (completed.length === total) {
            clearInterval(timer);
            timer = 0;
          }
          return;
        }
        setTimeout(() => {
          clicked[0].classList.remove('flipped');
          clicked[1].classList.remove('flipped');
          clicked = [];
          clickable = true;
        }, 1000);
      }

      function resetGame() {
        clearInterval(timer);
        timer = null;
        timerDisplay.textContent = '00:00';
        elapsedSeconds = 0;
        clickable = false;
        clicked = [];
        completed = [];
        wrapper.innerHTML = '';
        cardSetting();
        startButton.textContent = '다시하기';
        startGame();
      }

      function cardSetting() {
        clickable = false;
        shuffle();
        for (let i = 0; i < total; i++) {
          const card = createCard(i);
          card.addEventListener('click', (event) => {
            onClickCard(event);
          });
          wrapper.appendChild(card);
        }
      }

      async function flipAndStartGame() {
        // 1. 카드들을 1초 간격으로 뒤집기
        await new Promise((resolve) => {
          document.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => {
              card.classList.add('flipped');
              if (index === document.querySelectorAll('.card').length - 1) {
                resolve(); // 마지막 카드까지 뒤집었으면 resolve 호출
              }
            }, 1000 + 100 * index);
          });
        });

        // 2. 5초 후에 카드들의 flipped 클래스를 제거하고 타이머 시작
        setTimeout(() => {
          if (timer) clearInterval(timer);
          document.querySelectorAll('.card').forEach((card) => {
            card.classList.remove('flipped');
          });
          clickable = true;

          startTimer();
        }, 3000);
      }

      function startGame() {
        clickable = false;
        flipAndStartGame(); // 비동기적으로 처리되는 부분
      }

      function startTimer() {
        elapsedSeconds = 0;
        timerDisplay.textContent = '00:00';

        timer = setInterval(() => {
          elapsedSeconds += 1;
          const minutes = String(Math.floor(elapsedSeconds / 60)).padStart(
            2,
            '0'
          );
          const seconds = String(elapsedSeconds % 60).padStart(2, '0');
          timerDisplay.textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      cardSetting();

      startButton.addEventListener('click', () => {
        if (startButton.textContent === '시작하기') {
          startGame();
          startButton.textContent = '다시하기';
        } else {
          resetGame();
        }
      });
    </script>
  </body>
</html>
